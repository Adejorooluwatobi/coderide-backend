generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String          @id @default(uuid())
  email             String          @unique
  phone             String          @unique
  password          String
  firstName         String
  lastName          String
  profilePicture    String?
  userType          UserType
  isActive          Boolean         @default(true)
  isVerified        Boolean         @default(false)
  deletedAt         DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  driver            Driver?
  notifications     Notification[]
  paymentMethods    PaymentMethod[]
  receivedRatings   Rating[]        @relation("ReceivedRatings")
  sentRatings       Rating[]        @relation("SentRatings")
  referralsReceived Referral?       @relation("Referred")
  referralsGiven    Referral[]      @relation("Referrer")
  rider             Rider?
  supportTickets    SupportTicket[]
  ticketMessages    TicketMessage[]
}

model Rider {
  id                     String           @id @default(uuid())
  userId                 String           @unique
  defaultPaymentMethodId String?          @unique
  rating                 Decimal?
  totalRides             Int              @default(0)
  preferredLanguage      String?
  savedLocations         Json?
  payments               Payment[]        @relation("PaymentRider")
  defaultPaymentMethod   PaymentMethod?   @relation("DefaultPaymentMethod", fields: [defaultPaymentMethodId], references: [id])
  promotionUsages        PromotionUsage[]
  rides                  Ride[]
  user                   User             @relation(fields: [userId], references: [id])
}

model Driver {
  id                 String              @id @default(uuid())
  userId             String              @unique
  licenseNumber      String              @unique
  licenseExpiry      DateTime
  rating             Decimal?
  totalRides         Int                 @default(0)
  totalEarnings      Decimal             @default(0)
  isOnline           Boolean             @default(false)
  latitude           Float?
  longitude          Float?
  documentStatus     DocumentStatus      @default(PENDING)
  bankAccountDetails Json?
  user               User                @relation(fields: [userId], references: [id])
  documents          DriverDocument[]
  schedules          DriverSchedule[]
  earnings           Earning[]
  rides              Ride[]
  ownedVehicles      Vehicle[]           @relation("OwnedVehicles")
  vehicleAssignments VehicleAssignment[]

  @@index([latitude, longitude])
}

model Admin {
  id              String          @id @default(uuid())
  username        String          @unique
  password        String
  permissions     Int
  assignedTickets SupportTicket[]
}

model Vehicle {
  id              String              @id @default(uuid())
  ownershipType   VehicleOwnership    @default(DRIVER_OWNED)
  ownerId         String?
  licensePlate    String              @unique
  make            String
  model           String
  year            Int
  color           String
  category        VehicleCategory
  seats           Int
  insuranceExpiry DateTime
  vehiclePhotos   String[]
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  owner           Driver?             @relation("OwnedVehicles", fields: [ownerId], references: [id])
  assignments     VehicleAssignment[]

  @@index([ownershipType])
  @@index([ownerId])
}

model VehicleAssignment {
  id             String    @id @default(uuid())
  vehicleId      String
  driverId       String
  assignedAt     DateTime  @default(now())
  returnedAt     DateTime?
  startMileage   Int?
  endMileage     Int?
  fuelLevelStart Decimal?
  fuelLevelEnd   Decimal?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  driver         Driver    @relation(fields: [driverId], references: [id])
  vehicle        Vehicle   @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
  @@index([driverId])
  @@index([assignedAt])
  @@index([returnedAt])
}

model Ride {
  id                   String           @id @default(uuid())
  riderId              String
  driverId             String?
  pickupLatitude       Float
  pickupLongitude      Float
  pickupAddress        String
  destinationLatitude  Float
  destinationLongitude Float
  destinationAddress   String
  status               RideStatus       @default(REQUESTED)
  rideType             VehicleCategory
  estimatedDistance    Decimal?
  actualDistance       Decimal?
  estimatedDuration    Int?
  actualDuration       Int?
  estimatedPrice       Decimal?
  actualPrice          Decimal?
  requestedAt          DateTime         @default(now())
  acceptedAt           DateTime?
  startedAt            DateTime?
  completedAt          DateTime?
  cancelledAt          DateTime?
  cancellationReason   String?
  cancelledBy          CancelledBy?
  earnings             Earning?
  payment              Payment?
  promotionUsages      PromotionUsage[]
  ratings              Rating[]
  driver               Driver?          @relation(fields: [driverId], references: [id])
  rider                Rider            @relation(fields: [riderId], references: [id])
  trackingPoints       RideTracking[]
  supportTickets       SupportTicket[]

  @@index([status])
  @@index([riderId])
  @@index([driverId])
  @@index([requestedAt])
}

model Payment {
  id                   String        @id @default(uuid())
  rideId               String        @unique
  riderId              String
  amount               Decimal
  paymentMethod        PaymentType
  paymentStatus        PaymentStatus @default(PENDING)
  transactionReference String?       @unique
  paidAt               DateTime?
  currency             String        @default("NGN")
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  ride                 Ride          @relation(fields: [rideId], references: [id])
  rider                Rider         @relation("PaymentRider", fields: [riderId], references: [id])

  @@index([riderId])
  @@index([paymentStatus])
}

model PaymentMethod {
  id                  String            @id @default(uuid())
  userId              String
  type                PaymentMethodType
  cardLast4           String?
  cardBrand           String?
  isDefault           Boolean           @default(false)
  paymentGatewayToken String
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  defaultForRider     Rider?            @relation("DefaultPaymentMethod")
  user                User              @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Rating {
  id        String    @id @default(uuid())
  rideId    String
  raterId   String
  rateeId   String
  rating    Int
  comment   String?
  raterType RaterType
  createdAt DateTime  @default(now())
  ratee     User      @relation("ReceivedRatings", fields: [rateeId], references: [id])
  rater     User      @relation("SentRatings", fields: [raterId], references: [id])
  ride      Ride      @relation(fields: [rideId], references: [id])

  @@index([rideId])
  @@index([raterId])
  @@index([rateeId])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  metadata  Json?
  actionUrl String?
  imageUrl  String?
  expiresAt DateTime?
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userId, isRead])
  @@index([expiresAt])
}

model Promotion {
  id            String           @id @default(uuid())
  code          String           @unique
  description   String
  discountType  DiscountType
  discountValue Decimal
  maxDiscount   Decimal?
  minRideAmount Decimal?
  validFrom     DateTime
  validUntil    DateTime
  usageLimit    Int
  usedCount     Int              @default(0)
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  usages        PromotionUsage[]

  @@index([code])
  @@index([validFrom, validUntil])
}

model PromotionUsage {
  id             String    @id @default(uuid())
  promotionId    String
  riderId        String
  rideId         String
  discountAmount Decimal
  usedAt         DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  promotion      Promotion @relation(fields: [promotionId], references: [id])
  ride           Ride      @relation(fields: [rideId], references: [id])
  rider          Rider     @relation(fields: [riderId], references: [id])

  @@index([promotionId])
  @@index([riderId])
  @@index([rideId])
}

model Earning {
  id           String       @id @default(uuid())
  driverId     String
  rideId       String       @unique
  grossAmount  Decimal
  platformFee  Decimal
  netAmount    Decimal
  payoutStatus PayoutStatus @default(PENDING)
  paidOutAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  driver       Driver       @relation(fields: [driverId], references: [id])
  ride         Ride         @relation(fields: [rideId], references: [id])

  @@index([driverId])
  @@index([payoutStatus])
}

model FareEstimate {
  id                   String          @id @default(uuid())
  riderId              String?
  pickupLatitude       Float
  pickupLongitude      Float
  destinationLatitude  Float
  destinationLongitude Float
  estimatedPrice       Decimal
  estimatedDistance    Decimal
  estimatedDuration    Int
  vehicleCategory      VehicleCategory
  createdAt            DateTime        @default(now())

  @@index([riderId])
  @@index([createdAt])
}

model DriverSchedule {
  id        String   @id @default(uuid())
  driverId  String
  dayOfWeek Int
  startTime String
  endTime   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  driver    Driver   @relation(fields: [driverId], references: [id])

  @@index([driverId])
}

model DriverDocument {
  id              String         @id @default(uuid())
  driverId        String
  documentType    DocumentType
  documentUrl     String
  documentNumber  String?
  expiryDate      DateTime?
  status          DocumentStatus @default(PENDING)
  rejectionReason String?
  uploadedAt      DateTime       @default(now())
  verifiedAt      DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  driver          Driver         @relation(fields: [driverId], references: [id])

  @@index([driverId])
  @@index([status])
}

model Referral {
  id           String         @id @default(uuid())
  referrerId   String
  referredId   String         @unique
  code         String         @unique
  status       ReferralStatus @default(PENDING)
  rewardAmount Decimal?
  rewardedAt   DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  referred     User           @relation("Referred", fields: [referredId], references: [id])
  referrer     User           @relation("Referrer", fields: [referrerId], references: [id])

  @@index([referrerId])
  @@index([code])
}

model SupportTicket {
  id          String          @id @default(uuid())
  userId      String
  rideId      String?
  category    TicketCategory
  subject     String
  description String
  status      TicketStatus    @default(OPEN)
  priority    Priority        @default(MEDIUM)
  adminId     String?
  resolvedAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  assignedTo  Admin?          @relation(fields: [adminId], references: [id])
  ride        Ride?           @relation(fields: [rideId], references: [id])
  user        User            @relation(fields: [userId], references: [id])
  messages    TicketMessage[]

  @@index([userId])
  @@index([status])
  @@index([rideId])
  @@index([adminId])
}

model TicketMessage {
  id           String        @id @default(uuid())
  ticketId     String
  senderId     String
  message      String
  isAdminReply Boolean       @default(false)
  attachments  String[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  sender       User          @relation(fields: [senderId], references: [id])
  ticket       SupportTicket @relation(fields: [ticketId], references: [id])

  @@index([ticketId])
  @@index([senderId])
}

model SurgeZone {
  id         String    @id @default(uuid())
  name       String
  polygon    Json
  multiplier Decimal
  isActive   Boolean   @default(true)
  startTime  DateTime
  endTime    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([isActive])
  @@index([startTime, endTime])
}

model RideTracking {
  id        String   @id @default(uuid())
  rideId    String
  latitude  Float
  longitude Float
  timestamp DateTime @default(now())
  speed     Decimal?
  heading   Int?
  ride      Ride     @relation(fields: [rideId], references: [id])

  @@index([rideId])
}

enum VehicleOwnership {
  DRIVER_OWNED
  COMPANY_OWNED
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DocumentType {
  DRIVERS_LICENSE
  VEHICLE_REGISTRATION
  INSURANCE
  PROFILE_PHOTO
  VEHICLE_PHOTO
  BACKGROUND_CHECK
}

enum VehicleCategory {
  ECONOMY
  COMFORT
  PREMIUM
}

enum RideStatus {
  REQUESTED
  ACCEPTED
  ARRIVING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CancelledBy {
  RIDER
  DRIVER
}

enum PaymentType {
  CASH
  CARD
  WALLET
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethodType {
  CARD
  BANK_ACCOUNT
}

enum RaterType {
  RIDER
  DRIVER
}

enum NotificationType {
  RIDE_REQUEST
  RIDE_ACCEPTED
  PAYMENT
  PROMO
  SYSTEM
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

enum ReferralStatus {
  PENDING
  COMPLETED
  REWARDED
}

enum TicketCategory {
  RIDE_ISSUE
  PAYMENT_ISSUE
  DRIVER_BEHAVIOR
  RIDER_BEHAVIOR
  VEHICLE_ISSUE
  ACCOUNT_ISSUE
  TECHNICAL_ISSUE
  REFUND_REQUEST
  GENERAL_INQUIRY
  OTHER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_USER
  WAITING_FOR_ADMIN
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum UserType {
  RIDER
  DRIVER
}
